#' Find Differentially Methylated Regions across whole genome
#'
#' A function to define DMR for an entire chromosome
#'
#' @param tumor_table A matrix of beta values
#' @param control_table A matrix of beta values
#' @param auc_vector An numeric vector generated by [compute_AUC]
#' @param reference_table A data.frame reporting location of CpG probes (column and genomic_position)
#' @param length_cutoff An integer to remove streches of methylation that are
#' too short
#' @param na_cutoff An integer to set NAs to flanking states depending on their length
#'
#' @importFrom stats mad median p.adjust sd wilcox.test
#' @export
whole_genome_segmentator <- function(tumor_table, control_table, auc_vector,
  reference_table, na_cutoff = 5, length_cutoff = 3){
  tumor_table <- as.matrix(tumor_table)
  control_table <- as.matrix(control_table)
  stopifnot(is.numeric(auc_vector))
  stopifnot(is.data.frame(reference_table))
  if (nrow(tumor_table) != nrow(reference_table) || nrow(control_table) != nrow(reference_table)){
    stop("tumor_table and control_table must have same number of rows as reference_table")
  }
  tumor_is_fraction <- all(tumor_table >= 0, na.rm = T) && all(tumor_table <= 1, na.rm = T)
  control_is_fraction <- all(control_table >= 0, na.rm = T) && all(control_table <= 1, na.rm = T)
  if (tumor_is_fraction && control_is_fraction) {
    tumor_table <- tumor_table*100
    control_table <- control_table*100
    storage.mode(control_table) <- "integer"
    storage.mode(tumor_table) <- "integer"
  } else {
    stop("tumor_table and control_table must contain decimal values")
  }
  tumor_beta_mean <- apply(tumor_table, 1, mean, na.rm = T)
  control_beta_mean <- apply(control_table, 1, mean, na.rm = T)

  chromosomes <- unique(reference_table[[1]])
  all_chr_segs <- do.call("rbind", lapply(chromosomes, function(chr) {
    idx_chr <- which(reference_table[[1]] == chr)

    # 1) compute methylation states (1,2,3)
    meth_states <- meth_state_finder(auc_vector[idx_chr], reference_table[[2]][idx_chr],
      length_cutoff = length_cutoff, na_cutoff = na_cutoff)

    # 2) find segments for each chromosome
    single_chr_segs <- segmentator(meth_states, tumor_beta_mean[idx_chr],
      control_beta_mean[idx_chr])

    meth_states <- with(single_chr_segs, rep(state, nseg))
    rle_states <- S4Vectors::Rle(meth_states)
    rle_start <- S4Vectors::start(rle_states)
    rle_end <- S4Vectors::end(rle_states)

    return(data.frame(
      chr = reference_table[[1]][idx_chr[rle_start]],
      start = reference_table[[2]][idx_chr[rle_start]],
      end = reference_table[[2]][idx_chr[rle_end]],
      single_chr_segs))
  }))
  all_chr_segs$FDR <- p.adjust(all_chr_segs$pval, "fdr") # fdr (or BH)
  return(all_chr_segs)
}

#' Define Differentially Methylated Regions
#'
#' Given a set of methylation states produced by [meth_states_finder] and a set of
#' methylation (beta) values differences between tumor and control samples, this fucntion
#' defines stretches of equal states (segments).
#'
#' @param meth_states a vector of methylation states (1, 2, 3, NA)
#' @param tumor_beta_mean a vector of average methylation (beta) values
#' @param control_beta_mean a vector of average methylation (beta) values
#'
#' @return a data.frame with information about segments
#' @keywords internal
segmentator <- function(meth_states, tumor_beta_mean, control_beta_mean){
  stopifnot(all(meth_states %in% c(NA, 1:3)))
  stopifnot(is.numeric(tumor_beta_mean))
  stopifnot(is.numeric(control_beta_mean))
  stopifnot(length(tumor_beta_mean) == length(control_beta_mean))
  beta_diff <- tumor_beta_mean - control_beta_mean

  rle_states <- S4Vectors::Rle(meth_states)
  rle_length <- S4Vectors::runLength(rle_states)
  rle_value  <- S4Vectors::runValue(rle_states)
  rle_n      <- S4Vectors::nrun(rle_states)
  rle_start  <- S4Vectors::start(rle_states)
  rle_end    <- S4Vectors::end(rle_states)

  values <- matrix(nrow = rle_n, ncol = 2, dimnames = list(NULL, c("avg_beta_diff", "pval")))
  for (i in seq_len(rle_n)) {
    values[i, 1] <- mean(beta_diff[rle_start[i]: rle_end[i]], na.rm = T)
    if (rle_value[i] %in% c(1,3)) {
      values[i, 2] <- suppressWarnings(
        wilcox.test(tumor_beta_mean[rle_start[i]: rle_end[i]],
                    control_beta_mean[rle_start[i]: rle_end[i]],
                    ifelse(rle_value[i] == 3, "greater", "less"))$p.value)
    }
  }
  results <- data.frame(nseg = rle_length, state = rle_value, values)
  return(results)
}
